---
layout: post
title: '常见的部署方式'
tags: [code]
---

# 常见的部署方式

我们的系统会经常发布更新，有时更新系统会停机无法对用户提供服务。有时不会发生停机，用户并不知道我们在后台偷偷
修复了某个 "bug"或者增加了某项功能,下面会介绍常见的几种发布方式，如何让你"偷偷"的给用户加功能(bug)

## 重建部署

- 所谓的重建部署，其实就是在发布的时候将当前系统下面所有的实例都停机，对外不提供服务。然后由运维操作换包，重新启动实例。在成功后才可以提供服务给其他人或者业务方

### 优点
- 操作简单
- 应用状态完全统一
### 缺点
- 对于用户影响较大，
- 重建部署的消耗时间取决于实例下线和部署新实例的时间段，一般都比较长

## 滚动更新

- 版本 v2 通过缓慢的更新来代替老版本 v1，最终所有服务实例都会变成版本 v2

### 优点
- 便于设置
### 缺点
- 无法控制流量

## 影子部署

- 在版本 v1 接收到生产环境的请求之后，分流一部分到版本 v2，但是版本 v2 不需要响应这些流量。这样对生产环境没有影响，同时测试了版本 v2。经过验证
没有错误就可以逐步切换到新版本

### 优点
- 可以使用生产环境来做测试，而且不会影响生产环境
- 应用稳定之后切换，提高了系统的稳定性
### 缺点
- 需要部署2套独立的系统
- 实现较为复杂，尤其是在业务常见交叉的情况下，不一定能反映出来真实的场景
- 对于有些支付场景无法覆盖或者需要mock，会增加应用的复杂度

## 蓝绿部署

- 通过调整负载均衡指向了一个新版本的服务或者应用，以实现尽可能不中断业务服务的系统更新

### 优点
- 实现了比较平滑的应用发布，对系统服务的可用性影响时间较短
- 新老版本不会并行运行，兼容性较好
### 缺点
- 应用在发布的时候，需要短暂的迁移过程，在这期间会损失流量

## 金丝雀发布

- 金丝雀发布，同时也叫灰度发布，也是通过修改负载均衡，将流量切换到新版本的服务上，不过金丝雀是逐步切换到新版本。

如下图，负载均衡先切换了10%的流量到新版本v2，在v2表现稳定之后，会继续增加流量比重，一直到v2占有流量的100%。这次发布就算完成

```text

                                       +------------------------+
                                       |                        |
                                      >+         v1             |
+---------------------+       90%     ||                        |
|                     |               +-------------------------+
|      lb             +---------------+
|                     |               |
+---------------------+               +-------------------------+
                               10%    ||                        |
                                      >+          v2            |
                                       |                        |
                                       +------------------------+
```

### 优点
- 实现了非常平滑的应用发布，实现了不中断服务的系统升级部署
- 可以快速的故障切换
- 新老版本并行运行，可以对新版本进行流量测试
### 缺点
- 因为新老版本同时运行，对于应用升级的数据有一致性的要求，因此范围有限
- 一致性问题，数据的一致性需要技术手段进行保证，对于应用的编写和数据同步机制的实现有较高要求。技术门槛高

## A/B 测试

- A/B 测试指的是在特定的条件下将一部分用户的请求转发到新版本上。使用 A/B 测试一般是为了得出具有代表性的实验结论，相对于金丝雀发布，A/B 测试会在业务
请求的权重和流量切换上更加灵活，更加丰富的规则设置

### 优点
- 多个版本运行
- 流量分布准确

### 缺点

- 需要更加智能的负载均衡
- 对于特定的问题定位困难，需要引入服务性能监控系统
